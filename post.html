<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Heroes 歌唱比賽｜投票專區</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* 背景與整體 */
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#111;color:#f0f0f0;margin:0;padding:20px;text-align:center;position:relative;min-height:100vh;overflow-x:hidden}
    /* 粒子背景畫布：固定鋪滿、置底、不擋互動 */
    #particle-background{
      position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;pointer-events:none;
      filter:opacity(.55);
    }

    h1{color:#ffd700;text-shadow:2px 2px 4px #000,0 0 10px #ffd700;margin:8px 0 6px}
    .sub{margin:0 0 10px;color:#ccc}
    .updated{margin:0 auto 10px;color:#00ffff;font-size:.95em}
    a.back{color:#ffd700;text-decoration:none;border:1px solid #ffd700;border-radius:8px;padding:8px 12px;display:inline-block;margin:2px 0 14px;background:rgba(0,0,0,.2)}
    #search{margin:8px auto 16px;max-width:420px;width:90%;padding:10px;border-radius:10px;border:1px solid #555;background:#1b1b1b;color:#eee}
    table{border-collapse:collapse;margin:10px auto;width:95%;max-width:1100px;background:linear-gradient(145deg,#2a2a2a,#1c1c1c);border:3px solid transparent;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 0 10px rgba(255,255,255,.08)}
    th,td{border:1px solid #444;padding:12px 14px;text-align:center}
    th{background:linear-gradient(to bottom,#666,#222);color:#ffd700;border-bottom:2px solid #ffd700}
    tbody tr:hover{background:linear-gradient(145deg,#555,#333,#666)}
    button.vote{cursor:pointer;background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 12px;font-weight:700;box-shadow:0 4px 10px rgba(255,215,0,.25)}
    button.vote[disabled]{opacity:.6;cursor:not-allowed}
    #err{margin:10px auto 0;color:#ff6666;display:none}

    /* Modal（通用） */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .modal-overlay.show{opacity:1;pointer-events:auto;}
    .modal{background:#1b1b1b;border:1px solid #ffd700;border-radius:12px;padding:18px 20px;max-width:360px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.5), inset 0 0 8px rgba(255,255,255,.06)}
    .modal h3{margin:0 0 8px;color:#ffd700}
    .modal p{margin:0 0 12px;color:#eee}
    .modal .actions{display:flex;justify-content:center;gap:10px}
    .modal .actions button{background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 14px;font-weight:700;box-shadow:0 4px 10px rgba(255,215,0,.25);cursor:pointer}

    /* 排行榜 Modal */
    .rank-list{list-style:none;padding:0;margin:6px 0 0;text-align:left}
    .rank-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #333;border-radius:10px;margin:8px 0;background:#141414}
    .rank-left{display:flex;align-items:center;gap:10px}
    .medal{font-size:20px}
    .name{font-weight:700}
    .votes{color:#ffd700}

    /* Loading 遮罩（投票中 & 初始） */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;opacity:0;pointer-events:none;transition:opacity .15s ease}
    .loading-overlay.show{opacity:1;pointer-events:auto;}
    .spinner{width:56px;height:56px;border:4px solid rgba(255,255,255,.2);border-top-color:#ffd700;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px}
    .loading-text{color:#ffd700}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* 懸浮按鈕（右下排行榜） */
    .fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;background:#ffd700;color:#111;border:2px solid #111;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;cursor:pointer;z-index:9997;box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .fab:hover{transform:translateY(-1px)}

    /* 自動刷新時表格淡出提示 */
    tbody.fading{opacity:.4;transition:opacity .3s ease}

    /* 小螢幕優化 */
    @media (max-width: 480px){
      th,td{padding:10px}
      .fab{right:12px;bottom:12px}
    }
  </style>
</head>
<body>
  <!-- 粒子背景畫布 -->
  <canvas id="particle-background"></canvas>

  <h1>🎤 Heroes 歌唱比賽｜投票專區</h1>
  <p class="sub">⏳ 頁面將於 <span id="countdown">15</span> 秒後自動刷新</p>
  <div id="updated" class="updated">更新時間：—</div>
  <a class="back" href="./">← 返回節目單</a>

  <input id="search" type="text" placeholder="搜尋：序號 / 歌曲 / 演唱者…" />

  <table>
    <thead>
      <tr>
        <th>序號</th>
        <th>演唱歌曲</th>
        <th>演唱者</th>
        <th>目前票數（H）</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="5">載入中…</td></tr></tbody>
  </table>

  <div id="err"></div>

  <!-- 成功 Modal -->
  <div id="ok-overlay" class="modal-overlay">
    <div class="modal">
      <h3>投票成功</h3>
      <p>感謝你的支持 🙌</p>
      <div class="actions"><button id="ok-btn">知道了</button></div>
    </div>
  </div>

  <!-- 通用訊息 Modal（錯誤/提示/截止彈窗） -->
  <div id="msg-overlay" class="modal-overlay">
    <div class="modal">
      <h3 id="msg-title">提示</h3>
      <p id="msg-body">—</p>
      <div class="actions"><button id="msg-btn">知道了</button></div>
    </div>
  </div>

  <!-- 排行榜 Modal -->
  <div id="rank-overlay" class="modal-overlay">
    <div class="modal">
      <h3>目前排行榜（前三名）</h3>
      <ul id="rank-list" class="rank-list"></ul>
      <div class="actions"><button id="rank-close">關閉</button></div>
    </div>
  </div>

  <!-- 投票中 Loading -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">處理中…</div>
  </div>

  <!-- 初始載入 Loading -->
  <div id="init-loading" class="loading-overlay show">
    <div class="spinner"></div>
    <div class="loading-text">載入中…</div>
  </div>

  <!-- 懸浮排行榜按鈕 -->
  <button id="fab" class="fab" title="顯示前三名">🏆</button>

<script>
  // === 設定區 ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwZR2cTWJ3krasfegEf4ndSzkhnplT73I-yUoZ7VKxs93jd3aTRfu5cJJ1W9BDjoVjp/exec";
  const VOTED_GLOBAL_KEY = "heroes_voted_global";
  const POLL_SECONDS = 15;
  const VOTING_CLOSED = true; // ← 一進站即顯示截止、且按鈕關閉

  const tbody = document.getElementById('tbody');
  const errEl = document.getElementById('err');
  const updatedEl = document.getElementById('updated');
  const searchEl = document.getElementById('search');
  const initLoading = document.getElementById('init-loading');
  const loading = document.getElementById('loading');

  const okOverlay = document.getElementById('ok-overlay');
  const okBtn = document.getElementById('ok-btn');

  const msgOverlay = document.getElementById('msg-overlay');
  const msgTitle   = document.getElementById('msg-title');
  const msgBody    = document.getElementById('msg-body');
  const msgBtn     = document.getElementById('msg-btn');

  const rankOverlay = document.getElementById('rank-overlay');
  const rankList = document.getElementById('rank-list');
  const rankClose = document.getElementById('rank-close');
  const fab = document.getElementById('fab');

  const countdownEl = document.getElementById('countdown');

  let rows = [];
  let filtered = [];
  let countdown = POLL_SECONDS;
  let countdownTimer = null;

  // ===== 粒子背景 =====
  (function initParticles(){
    const canvas = document.getElementById('particle-background');
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);

    const particles = [];
    const COUNT = Math.min(120, Math.floor((window.innerWidth*window.innerHeight)/12000));
    for(let i=0;i<COUNT;i++){
      particles.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: Math.random()*2 + 1,
        vx: (Math.random()*0.4 - 0.2),
        vy: (Math.random()*0.4 - 0.2),
        a: Math.random()*0.9 + 0.1
      });
    }
    function step(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(const p of particles){
        p.x += p.vx; p.y += p.vy;
        if(p.x<0 || p.x>canvas.width) p.vx*=-1;
        if(p.y<0 || p.y>canvas.height) p.vy*=-1;
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${p.a})`;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  })();

  // ===== Modal / Loading =====
  function showOk(){ okOverlay.classList.add('show'); }
  function hideOk(){ okOverlay.classList.remove('show'); }
  okBtn.addEventListener('click', hideOk);
  okOverlay.addEventListener('click', (e)=>{ if(e.target===okOverlay) hideOk(); });

  function showMsg(title, body){
    if (title) msgTitle.textContent = title;
    if (body)  msgBody.textContent  = body;
    msgOverlay.classList.add('show');
  }
  function hideMsg(){ msgOverlay.classList.remove('show'); }
  msgBtn.addEventListener('click', hideMsg);
  msgOverlay.addEventListener('click', (e)=>{ if(e.target===msgOverlay) hideMsg(); });

  function showLoading(){ loading.classList.add('show'); }
  function hideLoading(){ loading.classList.remove('show'); }

  function openRank(){ updateTop3(); rankOverlay.classList.add('show'); }
  function closeRank(){ rankOverlay.classList.remove('show'); }
  document.getElementById('rank-close').addEventListener('click', closeRank);
  rankOverlay.addEventListener('click', (e)=>{ if(e.target===rankOverlay) closeRank(); });
  fab.addEventListener('click', openRank);

  // ===== 狀態存取 =====
  function hasVotedGlobal(){ return localStorage.getItem(VOTED_GLOBAL_KEY) === '1'; }
  function setVotedGlobal(){ localStorage.setItem(VOTED_GLOBAL_KEY, '1'); }

  // ===== 渲染 =====
  function render(list){
    const votedAll = hasVotedGlobal();
    tbody.innerHTML = '';
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5">沒有資料</td></tr>`;
      return;
    }
    list.forEach(r=>{
      const tr = document.createElement('tr');
      const disabled = VOTING_CLOSED || votedAll;
      tr.innerHTML = `
        <td>${r.id ?? ''}</td>
        <td>${r.title ?? ''}</td>
        <td>${r.singer ?? ''}</td>
        <td id="v-${r.id}">${typeof r.votes === 'number' ? r.votes : 0}</td>
        <td>
          <button class="vote" id="b-${r.id}" ${disabled ? 'disabled' : ''}>
            ${ VOTING_CLOSED ? '投票已截止' : (votedAll ? '投票完畢' : '投他一票') }
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('button.vote').addEventListener('click', ()=> vote(r.id));
    });
  }

  function applyFilter(){
    const q = searchEl.value.trim().toLowerCase();
    if(!q){ filtered = rows.slice(); }
    else{
      filtered = rows.filter(r =>
        String(r.id ?? '').toLowerCase().includes(q) ||
        String(r.title ?? '').toLowerCase().includes(q) ||
        String(r.singer ?? '').toLowerCase().includes(q)
      );
    }
    render(filtered);
  }

  // ===== 排行榜（前三名） =====
  function updateTop3(){
    const list = (rows || []).slice()
      .sort((a,b)=>{
        const va = Number(a.votes)||0, vb = Number(b.votes)||0;
        if (vb !== va) return vb - va;
        return Number(a.id) - Number(b.id);
      })
      .slice(0,3);

    const medal = ['🥇','🥈','🥉'];
    rankList.innerHTML = list.map((r,idx)=>`
      <li class="rank-item">
        <div class="rank-left">
          <span class="medal">${medal[idx]||''}</span>
          <div>
            <div class="name">${r.title || ''}</div>
            <div style="color:#ccc;">${r.singer || ''}（#${r.id}）</div>
          </div>
        </div>
        <div class="votes">${Number(r.votes)||0} 票</div>
      </li>
    `).join('') || `<li class="rank-item"><div>暫無資料</div></li>`;
  }

  // ===== 取得外網 IP（非阻塞；雖然截止了，保留不影響） =====
  let CLIENT_IP = 'unknown';
  async function fetchClientIP(){
    try{
      const r = await fetch('https://api.ipify.org?format=json', { cache:'no-store' });
      const j = await r.json();
      if (j && j.ip) CLIENT_IP = j.ip;
    }catch(_){}
  }
  fetchClientIP();

  // ===== 載入資料（支援自動刷新） =====
  async function load(isRefresh=false){
    if(!isRefresh) initLoading.classList.add('show');
    errEl.textContent = ''; errEl.style.display = 'none';
    try{
      if(isRefresh) tbody.classList.add('fading');
      const res = await fetch(API_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      rows = Array.isArray(data) ? data.slice().sort((a,b)=>Number(a.id)-Number(b.id))
           : (Array.isArray(data.rows) ? data.rows.slice().sort((a,b)=>Number(a.id)-Number(b.id)) : []);
      applyFilter();
      updatedEl.textContent = '更新時間：' + new Date().toLocaleString();
      updateTop3();
    }catch(e){
      console.error(e);
      showMsg('讀取失敗', e.message || '發生未知錯誤');
      if(!isRefresh) tbody.innerHTML = `<tr><td colspan="5">讀取失敗</td></tr>`;
    }finally{
      if(isRefresh) tbody.classList.remove('fading');
      initLoading.classList.remove('show');
    }
  }

  // ===== 自動刷新 =====
  function startCountdown(){
    clearInterval(countdownTimer);
    countdown = POLL_SECONDS;
    countdownEl.textContent = countdown;
    countdownTimer = setInterval(()=>{
      countdown--;
      if(countdown <= 0){
        countdown = POLL_SECONDS;
        load(true);
      }
      countdownEl.textContent = countdown;
    }, 1000);
  }

  // ===== 投票流程（截止：不送請求，直接彈窗） =====
  async function vote(id){
    if (VOTING_CLOSED){
      showMsg('投票已截止', '最終結果裁判依照正常數值計算');
      return;
    }
    if (hasVotedGlobal()) return;

    showLoading();
    try{
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({
          action: 'vote',
          id,
          voterIp: CLIENT_IP,
          ua: navigator.userAgent || ''
        })
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();

      if(!json.success){
        if (json.code === 'IP_DUP') {
          showMsg('已投過票', '此 IP 已投過票，不能重複投票。');
          setVotedGlobal();
          document.querySelectorAll('button.vote').forEach(b=>{
            b.textContent = '投票完畢';
            b.disabled = true;
          });
          return;
        }
        if (json.code === 'IP_REQUIRED') {
          showMsg('暫時無法投票', '未取得 IP，請稍後再試或重新整理頁面。');
          return;
        }
        showMsg('投票失敗', json.msg || '發生未知錯誤');
        return;
      }

      const cell = document.getElementById('v-' + id);
      if (cell) cell.textContent = json.votes;
      const found = rows.find(r=> String(r.id) === String(id));
      if (found) found.votes = json.votes;

      setVotedGlobal();
      document.querySelectorAll('button.vote').forEach(b=>{
        b.textContent = '投票完畢';
        b.disabled = true;
      });

      updatedEl.textContent = '更新時間：' + new Date().toLocaleString();
      updateTop3();
      showOk();
    }catch(e){
      console.error(e);
      showMsg('投票失敗', e.message || '發生未知錯誤');
    }finally{
      hideLoading();
    }
  }

  // ===== 啟動 =====
  searchEl.addEventListener('input', applyFilter);
  load(false).then(()=>{
    startCountdown();
    // 進站即彈出「已截止」
    if (VOTING_CLOSED){
      showMsg('投票已截止', '最終結果裁判依照正常數值計算');
    }
  });
</script>
</body>
</html>
