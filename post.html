<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Heroes æ­Œå”±æ¯”è³½ï½œæŠ•ç¥¨å°ˆå€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#111;color:#f0f0f0;margin:0;padding:20px;text-align:center}
    h1{color:#ffd700;text-shadow:2px 2px 4px #000,0 0 10px #ffd700;margin:8px 0 6px}
    .updated{margin:0 auto 12px;color:#00ffff;font-size:.95em}
    a.back{color:#ffd700;text-decoration:none;border:1px solid #ffd700;border-radius:8px;padding:8px 12px;display:inline-block;margin:2px 0 14px}
    #search{margin:8px auto 16px;max-width:420px;width:90%;padding:10px;border-radius:10px;border:1px solid #555;background:#1b1b1b;color:#eee}
    table{border-collapse:collapse;margin:10px auto;width:95%;max-width:1100px;background:linear-gradient(145deg,#2a2a2a,#1c1c1c);border:3px solid transparent;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 0 10px rgba(255,255,255,.08)}
    th,td{border:1px solid #444;padding:12px 14px;text-align:center}
    th{background:linear-gradient(to bottom,#666,#222);color:#ffd700;border-bottom:2px solid #ffd700}
    tbody tr:hover{background:linear-gradient(145deg,#555,#333,#666)}
    button.vote{cursor:pointer;background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 12px;font-weight:700;box-shadow:0 4px 10px rgba(255,215,0,.25)}
    button.vote[disabled]{opacity:.6;cursor:not-allowed}
    #err{margin:10px auto 0;color:#ff6666}

    /* Modalï¼ˆæŠ•ç¥¨æˆåŠŸï¼‰ */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:flex;align-items:center;justify-content:center;z-index:9999;
      opacity:0;pointer-events:none;transition:opacity .2s ease;
    }
    .modal-overlay.show{opacity:1;pointer-events:auto;}
    .modal{
      background:#1b1b1b;border:1px solid #ffd700;border-radius:12px;
      padding:18px 20px;max-width:320px;width:90%;
      box-shadow:0 10px 30px rgba(0,0,0,.5), inset 0 0 8px rgba(255,255,255,.06);
    }
    .modal h3{margin:0 0 8px;color:#ffd700}
    .modal p{margin:0 0 12px;color:#eee}
    .modal .actions{display:flex;justify-content:center}
    .modal .actions button{
      background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 14px;font-weight:700;
      box-shadow:0 4px 10px rgba(255,215,0,.25);cursor:pointer;
    }

    /* å…¨é  Loading é®ç½©ï¼ˆæŠ•ç¥¨ä¸­ & åˆå§‹ï¼‰ */
    .loading-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:9998;
      opacity:0;pointer-events:none;transition:opacity .15s ease;
    }
    .loading-overlay.show{opacity:1;pointer-events:auto;}
    .spinner{
      width:56px;height:56px;border:4px solid rgba(255,255,255,.2);
      border-top-color:#ffd700;border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:10px;
    }
    .loading-text{color:#ffd700}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <h1>ğŸ¤ æŠ•ç¥¨å°ˆå€</h1>
  <div id="updated" class="updated">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
  <a class="back" href="./">â† è¿”å›ç¯€ç›®å–®</a>

  <input id="search" type="text" placeholder="æœå°‹ï¼šåºè™Ÿ / æ­Œæ›² / æ¼”å”±è€…â€¦" />

  <table>
    <thead>
      <tr>
        <th>åºè™Ÿ</th>
        <th>æ¼”å”±æ­Œæ›²</th>
        <th>æ¼”å”±è€…</th>
        <th>ç›®å‰ç¥¨æ•¸ï¼ˆHï¼‰</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="5">è¼‰å…¥ä¸­â€¦</td></tr></tbody>
  </table>

  <div id="err"></div>

  <!-- æˆåŠŸ Modal -->
  <div id="overlay" class="modal-overlay">
    <div class="modal">
      <h3>æŠ•ç¥¨æˆåŠŸ</h3>
      <p>æ„Ÿè¬ä½ çš„æ”¯æŒ ğŸ™Œ</p>
      <div class="actions">
        <button id="modal-ok">çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- æŠ•ç¥¨ä¸­ Loading -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">è™•ç†ä¸­â€¦</div>
  </div>

  <!-- åˆå§‹è¼‰å…¥ Loading -->
  <div id="init-loading" class="loading-overlay show">
    <div class="spinner"></div>
    <div class="loading-text">è¼‰å…¥ä¸­â€¦</div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzXap2cdii9oK6KzA2qG5sc6IhOJhvzVSMTzAldKj0pCTK6sRB3A3-HcarcFM2LlJkOyw/exec";
  const VOTED_GLOBAL_KEY = "heroes_voted_global";

  const tbody = document.getElementById('tbody');
  const errEl = document.getElementById('err');
  const updatedEl = document.getElementById('updated');
  const searchEl = document.getElementById('search');
  const initLoading = document.getElementById('init-loading');
  const loading = document.getElementById('loading');

  // Modal
  const overlay = document.getElementById('overlay');
  const modalOk = document.getElementById('modal-ok');
  let autoCloseTimer = null;
  function showModal(){
    overlay.classList.add('show');
    clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(hideModal, 1500);
  }
  function hideModal(){
    overlay.classList.remove('show');
    clearTimeout(autoCloseTimer);
  }
  modalOk.addEventListener('click', hideModal);
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) hideModal(); });

  function showLoading(){ loading.classList.add('show'); }
  function hideLoading(){ loading.classList.remove('show'); }

  let rows = [];
  let filtered = [];

  function hasVotedGlobal(){ return localStorage.getItem(VOTED_GLOBAL_KEY) === '1'; }
  function setVotedGlobal(){ localStorage.setItem(VOTED_GLOBAL_KEY, '1'); }

  function render(list){
    const votedAll = hasVotedGlobal();
    tbody.innerHTML = '';
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5">æ²’æœ‰è³‡æ–™</td></tr>`;
      return;
    }
    list.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id ?? ''}</td>
        <td>${r.title ?? ''}</td>
        <td>${r.singer ?? ''}</td>
        <td id="v-${r.id}">${typeof r.votes === 'number' ? r.votes : 0}</td>
        <td>
          <button class="vote" id="b-${r.id}" ${votedAll ? 'disabled' : ''}>
            ${votedAll ? 'æŠ•ç¥¨å®Œç•¢' : 'æŠ•ä»–ä¸€ç¥¨'}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('button.vote').addEventListener('click', ()=> vote(r.id));
    });
  }

  function applyFilter(){
    const q = searchEl.value.trim().toLowerCase();
    if(!q){ filtered = rows.slice(); }
    else{
      filtered = rows.filter(r =>
        String(r.id ?? '').toLowerCase().includes(q) ||
        String(r.title ?? '').toLowerCase().includes(q) ||
        String(r.singer ?? '').toLowerCase().includes(q)
      );
    }
    render(filtered);
  }

  async function load(){
    errEl.textContent = '';
    try{
      const res = await fetch(API_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      rows = Array.isArray(data) ? data.slice().sort((a,b)=>Number(a.id)-Number(b.id)) : [];
      filtered = rows.slice();
      render(filtered);
      updatedEl.textContent = 'æ›´æ–°æ™‚é–“ï¼š' + new Date().toLocaleString();
    }catch(e){
      console.error(e);
      errEl.textContent = 'è®€å–å¤±æ•—ï¼š' + e.message;
      tbody.innerHTML = `<tr><td colspan="5">è®€å–å¤±æ•—</td></tr>`;
    }finally{
      // åˆå§‹è¼‰å…¥å®Œæˆï¼Œç§»é™¤é®ç½©
      initLoading.classList.remove('show');
    }
  }

  function disableAllButtons(){
    document.querySelectorAll('button.vote').forEach(b=>{
      b.textContent = 'æŠ•ç¥¨å®Œç•¢';
      b.disabled = true;
    });
  }

  async function vote(id){
    if (hasVotedGlobal()) return;
    errEl.textContent = '';
    showLoading();

    try{
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'vote', id })
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if(!json.success){ throw new Error(json.msg || 'æŠ•ç¥¨å¤±æ•—'); }

      const cell = document.getElementById('v-' + id);
      if (cell) cell.textContent = json.votes;

      setVotedGlobal();
      disableAllButtons();
      showModal();
    }catch(e){
      console.error(e);
      errEl.textContent = 'æŠ•ç¥¨å¤±æ•—ï¼š' + e.message;
    }finally{
      hideLoading();
    }
  }

  searchEl.addEventListener('input', applyFilter);
  load();
</script>
</body>
</html>
