<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Heroes æ­Œå”±æ¯”è³½ï½œæŠ•ç¥¨å°ˆå€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* èƒŒæ™¯èˆ‡æ•´é«” */
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#111;color:#f0f0f0;margin:0;padding:20px;text-align:center;position:relative;min-height:100vh;overflow-x:hidden}
    /* ç²’å­èƒŒæ™¯ç•«å¸ƒï¼šå›ºå®šé‹ªæ»¿ã€ç½®åº•ã€ä¸æ“‹äº’å‹• */
    #particle-background{
      position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;pointer-events:none;
      filter:opacity(.55);
    }

    h1{color:#ffd700;text-shadow:2px 2px 4px #000,0 0 10px #ffd700;margin:8px 0 6px}
    .sub{margin:0 0 10px;color:#ccc}
    .updated{margin:0 auto 10px;color:#00ffff;font-size:.95em}
    a.back{color:#ffd700;text-decoration:none;border:1px solid #ffd700;border-radius:8px;padding:8px 12px;display:inline-block;margin:2px 0 14px;background:rgba(0,0,0,.2)}
    #search{margin:8px auto 16px;max-width:420px;width:90%;padding:10px;border-radius:10px;border:1px solid #555;background:#1b1b1b;color:#eee}
    table{border-collapse:collapse;margin:10px auto;width:95%;max-width:1100px;background:linear-gradient(145deg,#2a2a2a,#1c1c1c);border:3px solid transparent;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5),inset 0 0 10px rgba(255,255,255,.08)}
    th,td{border:1px solid #444;padding:12px 14px;text-align:center}
    th{background:linear-gradient(to bottom,#666,#222);color:#ffd700;border-bottom:2px solid #ffd700}
    tbody tr:hover{background:linear-gradient(145deg,#555,#333,#666)}
    button.vote{cursor:pointer;background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 12px;font-weight:700;box-shadow:0 4px 10px rgba(255,215,0,.25)}
    button.vote[disabled]{opacity:.6;cursor:not-allowed}
    #err{margin:10px auto 0;color:#ff6666;display:none}

    /* Modalï¼ˆé€šç”¨ï¼‰ */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .modal-overlay.show{opacity:1;pointer-events:auto;}
    .modal{background:#1b1b1b;border:1px solid #ffd700;border-radius:12px;padding:18px 20px;max-width:360px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.5), inset 0 0 8px rgba(255,255,255,.06)}
    .modal h3{margin:0 0 8px;color:#ffd700}
    .modal p{margin:0 0 12px;color:#eee}
    .modal .actions{display:flex;justify-content:center;gap:10px}
    .modal .actions button{background:#ffd700;color:#111;border:0;border-radius:8px;padding:8px 14px;font-weight:700;box-shadow:0 4px 10px rgba(255,215,0,.25);cursor:pointer}

    /* æ’è¡Œæ¦œ Modal */
    .rank-list{list-style:none;padding:0;margin:6px 0 0;text-align:left}
    .rank-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #333;border-radius:10px;margin:8px 0;background:#141414}
    .rank-left{display:flex;align-items:center;gap:10px}
    .medal{font-size:20px}
    .name{font-weight:700}
    .votes{color:#ffd700}

    /* Loading é®ç½©ï¼ˆæŠ•ç¥¨ä¸­ & åˆå§‹ï¼‰ */
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;opacity:0;pointer-events:none;transition:opacity .15s ease}
    .loading-overlay.show{opacity:1;pointer-events:auto;}
    .spinner{width:56px;height:56px;border:4px solid rgba(255,255,255,.2);border-top-color:#ffd700;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px}
    .loading-text{color:#ffd700}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* æ‡¸æµ®æŒ‰éˆ•ï¼ˆå³ä¸‹æ’è¡Œæ¦œï¼‰ */
    .fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;background:#ffd700;color:#111;border:2px solid #111;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;cursor:pointer;z-index:9997;box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .fab:hover{transform:translateY(-1px)}

    /* è‡ªå‹•åˆ·æ–°æ™‚è¡¨æ ¼æ·¡å‡ºæç¤º */
    tbody.fading{opacity:.4;transition:opacity .3s ease}

    /* å°è¢å¹•å„ªåŒ– */
    @media (max-width: 480px){
      th,td{padding:10px}
      .fab{right:12px;bottom:12px}
    }
  </style>
</head>
<body>
  <!-- ç²’å­èƒŒæ™¯ç•«å¸ƒ -->
  <canvas id="particle-background"></canvas>

  <h1>ğŸ¤ Heroes æ­Œå”±æ¯”è³½ï½œæŠ•ç¥¨å°ˆå€</h1>
  <p class="sub">â³ é é¢å°‡æ–¼ <span id="countdown">15</span> ç§’å¾Œè‡ªå‹•åˆ·æ–°</p>
  <div id="updated" class="updated">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
  <a class="back" href="./">â† è¿”å›ç¯€ç›®å–®</a>

  <input id="search" type="text" placeholder="æœå°‹ï¼šåºè™Ÿ / æ­Œæ›² / æ¼”å”±è€…â€¦" />

  <table>
    <thead>
      <tr>
        <th>åºè™Ÿ</th>
        <th>æ¼”å”±æ­Œæ›²</th>
        <th>æ¼”å”±è€…</th>
        <th>ç›®å‰ç¥¨æ•¸ï¼ˆHï¼‰</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="5">è¼‰å…¥ä¸­â€¦</td></tr></tbody>
  </table>

  <div id="err"></div>

  <!-- æˆåŠŸ Modal -->
  <div id="ok-overlay" class="modal-overlay">
    <div class="modal">
      <h3>æŠ•ç¥¨æˆåŠŸ</h3>
      <p>æ„Ÿè¬ä½ çš„æ”¯æŒ ğŸ™Œ</p>
      <div class="actions"><button id="ok-btn">çŸ¥é“äº†</button></div>
    </div>
  </div>

  <!-- é€šç”¨è¨Šæ¯ Modalï¼ˆéŒ¯èª¤/æç¤º/æˆªæ­¢å½ˆçª—ï¼‰ -->
  <div id="msg-overlay" class="modal-overlay">
    <div class="modal">
      <h3 id="msg-title">æç¤º</h3>
      <p id="msg-body">â€”</p>
      <div class="actions"><button id="msg-btn">çŸ¥é“äº†</button></div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œ Modal -->
  <div id="rank-overlay" class="modal-overlay">
    <div class="modal">
      <h3>ç›®å‰æ’è¡Œæ¦œï¼ˆå‰ä¸‰åï¼‰</h3>
      <ul id="rank-list" class="rank-list"></ul>
      <div class="actions"><button id="rank-close">é—œé–‰</button></div>
    </div>
  </div>

  <!-- æŠ•ç¥¨ä¸­ Loading -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">è™•ç†ä¸­â€¦</div>
  </div>

  <!-- åˆå§‹è¼‰å…¥ Loading -->
  <div id="init-loading" class="loading-overlay show">
    <div class="spinner"></div>
    <div class="loading-text">è¼‰å…¥ä¸­â€¦</div>
  </div>

  <!-- æ‡¸æµ®æ’è¡Œæ¦œæŒ‰éˆ• -->
  <button id="fab" class="fab" title="é¡¯ç¤ºå‰ä¸‰å">ğŸ†</button>

<script>
  // === è¨­å®šå€ ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwZR2cTWJ3krasfegEf4ndSzkhnplT73I-yUoZ7VKxs93jd3aTRfu5cJJ1W9BDjoVjp/exec";
  const VOTED_GLOBAL_KEY = "heroes_voted_global";
  const POLL_SECONDS = 15;
  const VOTING_CLOSED = true; // â† ä¸€é€²ç«™å³é¡¯ç¤ºæˆªæ­¢ã€ä¸”æŒ‰éˆ•é—œé–‰

  const tbody = document.getElementById('tbody');
  const errEl = document.getElementById('err');
  const updatedEl = document.getElementById('updated');
  const searchEl = document.getElementById('search');
  const initLoading = document.getElementById('init-loading');
  const loading = document.getElementById('loading');

  const okOverlay = document.getElementById('ok-overlay');
  const okBtn = document.getElementById('ok-btn');

  const msgOverlay = document.getElementById('msg-overlay');
  const msgTitle   = document.getElementById('msg-title');
  const msgBody    = document.getElementById('msg-body');
  const msgBtn     = document.getElementById('msg-btn');

  const rankOverlay = document.getElementById('rank-overlay');
  const rankList = document.getElementById('rank-list');
  const rankClose = document.getElementById('rank-close');
  const fab = document.getElementById('fab');

  const countdownEl = document.getElementById('countdown');

  let rows = [];
  let filtered = [];
  let countdown = POLL_SECONDS;
  let countdownTimer = null;

  // ===== ç²’å­èƒŒæ™¯ =====
  (function initParticles(){
    const canvas = document.getElementById('particle-background');
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);

    const particles = [];
    const COUNT = Math.min(120, Math.floor((window.innerWidth*window.innerHeight)/12000));
    for(let i=0;i<COUNT;i++){
      particles.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: Math.random()*2 + 1,
        vx: (Math.random()*0.4 - 0.2),
        vy: (Math.random()*0.4 - 0.2),
        a: Math.random()*0.9 + 0.1
      });
    }
    function step(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(const p of particles){
        p.x += p.vx; p.y += p.vy;
        if(p.x<0 || p.x>canvas.width) p.vx*=-1;
        if(p.y<0 || p.y>canvas.height) p.vy*=-1;
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${p.a})`;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  })();

  // ===== Modal / Loading =====
  function showOk(){ okOverlay.classList.add('show'); }
  function hideOk(){ okOverlay.classList.remove('show'); }
  okBtn.addEventListener('click', hideOk);
  okOverlay.addEventListener('click', (e)=>{ if(e.target===okOverlay) hideOk(); });

  function showMsg(title, body){
    if (title) msgTitle.textContent = title;
    if (body)  msgBody.textContent  = body;
    msgOverlay.classList.add('show');
  }
  function hideMsg(){ msgOverlay.classList.remove('show'); }
  msgBtn.addEventListener('click', hideMsg);
  msgOverlay.addEventListener('click', (e)=>{ if(e.target===msgOverlay) hideMsg(); });

  function showLoading(){ loading.classList.add('show'); }
  function hideLoading(){ loading.classList.remove('show'); }

  function openRank(){ updateTop3(); rankOverlay.classList.add('show'); }
  function closeRank(){ rankOverlay.classList.remove('show'); }
  document.getElementById('rank-close').addEventListener('click', closeRank);
  rankOverlay.addEventListener('click', (e)=>{ if(e.target===rankOverlay) closeRank(); });
  fab.addEventListener('click', openRank);

  // ===== ç‹€æ…‹å­˜å– =====
  function hasVotedGlobal(){ return localStorage.getItem(VOTED_GLOBAL_KEY) === '1'; }
  function setVotedGlobal(){ localStorage.setItem(VOTED_GLOBAL_KEY, '1'); }

  // ===== æ¸²æŸ“ =====
  function render(list){
    const votedAll = hasVotedGlobal();
    tbody.innerHTML = '';
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="5">æ²’æœ‰è³‡æ–™</td></tr>`;
      return;
    }
    list.forEach(r=>{
      const tr = document.createElement('tr');
      const disabled = VOTING_CLOSED || votedAll;
      tr.innerHTML = `
        <td>${r.id ?? ''}</td>
        <td>${r.title ?? ''}</td>
        <td>${r.singer ?? ''}</td>
        <td id="v-${r.id}">${typeof r.votes === 'number' ? r.votes : 0}</td>
        <td>
          <button class="vote" id="b-${r.id}" ${disabled ? 'disabled' : ''}>
            ${ VOTING_CLOSED ? 'æŠ•ç¥¨å·²æˆªæ­¢' : (votedAll ? 'æŠ•ç¥¨å®Œç•¢' : 'æŠ•ä»–ä¸€ç¥¨') }
          </button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector('button.vote').addEventListener('click', ()=> vote(r.id));
    });
  }

  function applyFilter(){
    const q = searchEl.value.trim().toLowerCase();
    if(!q){ filtered = rows.slice(); }
    else{
      filtered = rows.filter(r =>
        String(r.id ?? '').toLowerCase().includes(q) ||
        String(r.title ?? '').toLowerCase().includes(q) ||
        String(r.singer ?? '').toLowerCase().includes(q)
      );
    }
    render(filtered);
  }

  // ===== æ’è¡Œæ¦œï¼ˆå‰ä¸‰åï¼‰ =====
  function updateTop3(){
    const list = (rows || []).slice()
      .sort((a,b)=>{
        const va = Number(a.votes)||0, vb = Number(b.votes)||0;
        if (vb !== va) return vb - va;
        return Number(a.id) - Number(b.id);
      })
      .slice(0,3);

    const medal = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    rankList.innerHTML = list.map((r,idx)=>`
      <li class="rank-item">
        <div class="rank-left">
          <span class="medal">${medal[idx]||''}</span>
          <div>
            <div class="name">${r.title || ''}</div>
            <div style="color:#ccc;">${r.singer || ''}ï¼ˆ#${r.id}ï¼‰</div>
          </div>
        </div>
        <div class="votes">${Number(r.votes)||0} ç¥¨</div>
      </li>
    `).join('') || `<li class="rank-item"><div>æš«ç„¡è³‡æ–™</div></li>`;
  }

  // ===== å–å¾—å¤–ç¶² IPï¼ˆéé˜»å¡ï¼›é›–ç„¶æˆªæ­¢äº†ï¼Œä¿ç•™ä¸å½±éŸ¿ï¼‰ =====
  let CLIENT_IP = 'unknown';
  async function fetchClientIP(){
    try{
      const r = await fetch('https://api.ipify.org?format=json', { cache:'no-store' });
      const j = await r.json();
      if (j && j.ip) CLIENT_IP = j.ip;
    }catch(_){}
  }
  fetchClientIP();

  // ===== è¼‰å…¥è³‡æ–™ï¼ˆæ”¯æ´è‡ªå‹•åˆ·æ–°ï¼‰ =====
  async function load(isRefresh=false){
    if(!isRefresh) initLoading.classList.add('show');
    errEl.textContent = ''; errEl.style.display = 'none';
    try{
      if(isRefresh) tbody.classList.add('fading');
      const res = await fetch(API_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      rows = Array.isArray(data) ? data.slice().sort((a,b)=>Number(a.id)-Number(b.id))
           : (Array.isArray(data.rows) ? data.rows.slice().sort((a,b)=>Number(a.id)-Number(b.id)) : []);
      applyFilter();
      updatedEl.textContent = 'æ›´æ–°æ™‚é–“ï¼š' + new Date().toLocaleString();
      updateTop3();
    }catch(e){
      console.error(e);
      showMsg('è®€å–å¤±æ•—', e.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
      if(!isRefresh) tbody.innerHTML = `<tr><td colspan="5">è®€å–å¤±æ•—</td></tr>`;
    }finally{
      if(isRefresh) tbody.classList.remove('fading');
      initLoading.classList.remove('show');
    }
  }

  // ===== è‡ªå‹•åˆ·æ–° =====
  function startCountdown(){
    clearInterval(countdownTimer);
    countdown = POLL_SECONDS;
    countdownEl.textContent = countdown;
    countdownTimer = setInterval(()=>{
      countdown--;
      if(countdown <= 0){
        countdown = POLL_SECONDS;
        load(true);
      }
      countdownEl.textContent = countdown;
    }, 1000);
  }

  // ===== æŠ•ç¥¨æµç¨‹ï¼ˆæˆªæ­¢ï¼šä¸é€è«‹æ±‚ï¼Œç›´æ¥å½ˆçª—ï¼‰ =====
  async function vote(id){
    if (VOTING_CLOSED){
      showMsg('æŠ•ç¥¨å·²æˆªæ­¢', 'æœ€çµ‚çµæœè£åˆ¤ä¾ç…§æ­£å¸¸æ•¸å€¼è¨ˆç®—');
      return;
    }
    if (hasVotedGlobal()) return;

    showLoading();
    try{
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({
          action: 'vote',
          id,
          voterIp: CLIENT_IP,
          ua: navigator.userAgent || ''
        })
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();

      if(!json.success){
        if (json.code === 'IP_DUP') {
          showMsg('å·²æŠ•éç¥¨', 'æ­¤ IP å·²æŠ•éç¥¨ï¼Œä¸èƒ½é‡è¤‡æŠ•ç¥¨ã€‚');
          setVotedGlobal();
          document.querySelectorAll('button.vote').forEach(b=>{
            b.textContent = 'æŠ•ç¥¨å®Œç•¢';
            b.disabled = true;
          });
          return;
        }
        if (json.code === 'IP_REQUIRED') {
          showMsg('æš«æ™‚ç„¡æ³•æŠ•ç¥¨', 'æœªå–å¾— IPï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é‡æ–°æ•´ç†é é¢ã€‚');
          return;
        }
        showMsg('æŠ•ç¥¨å¤±æ•—', json.msg || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
        return;
      }

      const cell = document.getElementById('v-' + id);
      if (cell) cell.textContent = json.votes;
      const found = rows.find(r=> String(r.id) === String(id));
      if (found) found.votes = json.votes;

      setVotedGlobal();
      document.querySelectorAll('button.vote').forEach(b=>{
        b.textContent = 'æŠ•ç¥¨å®Œç•¢';
        b.disabled = true;
      });

      updatedEl.textContent = 'æ›´æ–°æ™‚é–“ï¼š' + new Date().toLocaleString();
      updateTop3();
      showOk();
    }catch(e){
      console.error(e);
      showMsg('æŠ•ç¥¨å¤±æ•—', e.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
    }finally{
      hideLoading();
    }
  }

  // ===== å•Ÿå‹• =====
  searchEl.addEventListener('input', applyFilter);
  load(false).then(()=>{
    startCountdown();
    // é€²ç«™å³å½ˆå‡ºã€Œå·²æˆªæ­¢ã€
    if (VOTING_CLOSED){
      showMsg('æŠ•ç¥¨å·²æˆªæ­¢', 'æœ€çµ‚çµæœè£åˆ¤ä¾ç…§æ­£å¸¸æ•¸å€¼è¨ˆç®—');
    }
  });
</script>
</body>
</html>
